# Сервис сбора данных с метеостанций

Сервис для регулярного сбора данных с метеостанций погодавполе.рф и сохранения их в базу данных MS SQL Server.

## Описание

Сервис выполняет следующие функции:

* Авторизация в API погодавполе.рф
* Получение списка всех доступных метеостанций
* Сбор телеметрии с каждой метеостанции (включая данные о накопленных осадках)
* Сохранение данных в базу данных MS SQL Server
* Регулярный запуск сбора данных с настраиваемым интервалом

## Особенности и улучшения

* **Интеллектуальное восстановление после сбоев** - при запуске сервис проверяет последние записи в базе данных для каждой станции и запрашивает данные с этого момента, что гарантирует отсутствие пропусков даже при временной недоступности сервиса
* **Инициализация новых станций** - для новых метеостанций (без предыдущих записей в базе) автоматически запрашиваются данные за последний год
* **Оптимизация запросов данных** - запрашиваются только новые данные с момента последней записи для каждой метеостанции
* **Защита от устаревших данных** - если последние данные в базе старше месяца, запрашивается только стандартный интервал
* **Надежное хранение данных** - использование MS SQL Server с оптимизированной структурой таблиц

## Требования

* Go 1.16 или выше
* Доступ к API погодавполе.рф (логин/пароль)
* Доступ к базе данных MS SQL Server

## Установка

1. Клонируйте репозиторий:
   ```
   git clone https://github.com/memrook/weatherInTheField.git
   cd weatherInTheField
   ```

2. Скопируйте файл `.env.example` в `.env` и настройте переменные окружения:
   ```
   cp .env.example .env
   ```

3. Отредактируйте файл `.env`, указав ваши учетные данные для API и базы данных

4. Соберите сервис:
   ```
   go build -o weatherservice ./cmd/weatherservice
   ```

## Запуск

```
./weatherservice
```

## Docker

### Сборка образа

```
docker build -t weather-service .
```

### Запуск в контейнере

```
docker run -d --name weather-service \
  --env-file .env \
  weather-service
```

## Настройка

Настройка сервиса осуществляется через переменные окружения:

* `API_LOGIN` - логин для API погодавполе.рф
* `API_PASSWORD` - пароль для API
* `API_BASE_URL` - базовый URL API (по умолчанию https://api3.погодавполе.рф)
* `DB_SERVER` - адрес сервера базы данных MS SQL
* `DB_LOGIN` - логин для базы данных
* `DB_PASSWORD` - пароль для базы данных
* `DB_NAME` - имя базы данных (по умолчанию WeatherData)
* `COLLECTION_INTERVAL` - интервал сбора данных в минутах (по умолчанию 15)

## Структура базы данных

Сервис автоматически создает необходимые таблицы:

### Stations

Таблица с информацией о метеостанциях.

| Поле       | Тип            | Описание                       |
|------------|----------------|--------------------------------|
| ID         | NVARCHAR(100)  | Уникальный идентификатор       |
| Name       | NVARCHAR(100)  | Внутреннее имя метеостанции    |
| Label      | NVARCHAR(255)  | Пользовательское имя           |
| Latitude   | FLOAT          | Широта                         |
| Longitude  | FLOAT          | Долгота                        |
| LastUpdate | DATETIME       | Время последнего обновления    |

### Telemetry

Таблица с данными телеметрии.

| Поле       | Тип            | Описание                       |
|------------|----------------|--------------------------------|
| ID         | INT            | Автоинкрементный ID            |
| StationID  | NVARCHAR(100)  | ID метеостанции (внешний ключ) |
| SensorKey  | NVARCHAR(100)  | Ключ датчика                   |
| Timestamp  | BIGINT         | Timestamp (миллисекунды)       |
| DateValue  | DATETIME       | Время в формате DateTime       |
| Value      | FLOAT          | Значение датчика               |

## Последние изменения

* Адаптирован код для работы с обновленным API погодавполе.рф (новые структуры запросов и ответов)
* Исправлена работа с MS SQL Server - реализованы именованные параметры вместо знаков вопроса
* Добавлена интеллектуальная стратегия получения данных с учетом последних записей в базе данных
* Реализован механизм получения исторических данных за год для новых метеостанций
* Оптимизировано логирование для лучшего отслеживания процесса сбора данных
* Добавлены проверки на наличие новых данных перед сохранением

## Лицензия

MIT 