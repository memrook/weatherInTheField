# Спецификация API сервиса погодавполе.рф

API сервиса **pogodavpole.rf** предоставляет доступ к данным и управлению устройствами, телеметрией, инцидентами и другими функциями. Все запросы к API отправляются методом **POST** и доступны по двум адресам:

- **https://api3.погодавполе.рф**
- **https://api3.ttrackagro.ru** (альтернативный адрес для некириллических доменов)

Для доступа к большинству методов требуется токен сессии (`sid`), который можно получить через метод `/login`. Документация API доступна по адресу [http://api3.погодавполе.рф/apidocs](http://api3.погодавполе.рф/apidocs), а готовый клиент для работы с данными — на [https://new.погодавполе.рф](https://new.погодавполе.рф).

---

## Общая информация

- **Метод запросов:** POST
- **Токен доступа:** Параметр `sid` обязателен для всех запросов, кроме `/login`.
- **Формат данных:** JSON (в запросах и ответах).
- **Обработка ошибок:** В случае ошибки возвращается объект с полями:
  - `status` (string) — "error".
  - `error` (string) — описание ошибки.
  - `additional_code` (string, необязательный) — дополнительное описание ошибки.

---

## Методы API

### 1. Авторизация

#### `/login`
- **Описание:** Получение токена сессии для доступа к API.
- **Параметры:**
  - `login` (string, обязательный) — логин пользователя.
  - `password` (string, обязательный) — пароль пользователя.
- **Ответ:**
  - `sid` (string) — токен сессии для использования в запросах.
  - `refresh` (string) — токен обновления для получения нового `sid`.
  - `account` (string) — имя текущего пользователя.
  - `is_admin` (boolean) — признак администратора (полный доступ).
  - `special_type` (string) — особый режим работы сессии.
- **Пример запроса:**
  ```json
  {
    "login": "user@example.com",
    "password": "password123"
  }
  ```
---

### 2. Управление устройствами

#### `/devices`
- **Описание:** Получение списка устройств с фильтрацией и пагинацией.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `filter` (object, необязательный) — настройки фильтрации (например, `{ "name": "устройство1" }` для поиска по имени).
  - `page_size` (long, необязательный) — размер страницы. НЕ РЕАЛИЗОВАНО (500)
  - `page_num` (long, необязательный) — номер страницы. НЕ РЕАЛИЗОВАНО (500)
- **Ответ:**
  - Массив объектов с данными устройств:
    - `id` (string) — ID устройства.
    - `name` (string) — внутреннее уникальное имя.
    - `label` (string) — пользовательское имя.
    - `last_msg` (string) — дата последнего сообщения.
    - `latitude` (number) — широта.
    - `longitude` (number) — долгота.
    - `airtemp` (number) — температура воздуха.
    - `rainfall_daily` (number) — осадки за сутки.
    - `battery` (number) — заряд аккумулятора.
    - `clients` (array) — список учетных записей с доступом:
      - `id` (string) — ID учетной записи.
      - `name` (string) — имя учетной записи.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "filter": {
      "name": "метеостанция"
    },
    "page_size": 10,
    "page_num": 1
  }
  
#### `/device`
- **Методы:** POST, PUT
- **Описание:** Получение (POST) или изменение (PUT) данных устройства.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, обязательный) — ID устройства.
  - `data` (object, обязательный для PUT) — данные для изменения:
    - `label` (string) — пользовательское имя.
    - `name` (string) — внутреннее имя.
    - `type` (string) — тип устройства.
- **Ответ:**
  - Объект устройства:
    - `alarm_settings` (object) — настройки оповещений:
      - `event_type` (object):
        - `event_name` (string) — название события.
        - `threshold` (number) — пороговое значение.
    - `clients` (array) — учетные записи с доступом.
    - `id` (string) — ID устройства.
    - `imei` (string) — IMEI устройства.
    - `label` (string) — пользовательское имя.
    - `last_msg` (string) — дата последнего сообщения.
    - `name` (string) — внутреннее имя.
    - `sensors` (object) — подключенные датчики:
      - `<тип_датчика>` (object):
        - `active` (boolean) — активность датчика.
        - `custom_name` (string) — пользовательское имя датчика.
        - `last_value` (number) — последнее значение.
        - `name` (string) — имя датчика.
        - `ts` (number) — время последнего значения.
        - `unit` (string) — единица измерения.
- **Пример запроса POST:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "device_id_123"                  // ID устройства
  }
  ```
  - **Пример запроса PUT:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "device_id_123",                 // ID устройства
    "data": {
      "label": "Новая метка устройства",
      "name": "new_device_name",
      "type": "weather_station"
    }
  }
  ```
#### `/device-msg`
- **Описание:** Получение последних сообщений от устройства.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, обязательный) — ID устройства.
  - `msg_count` (integer, необязательный) — количество сообщений.
- **Ответ:**
  - Список сообщений от устройства.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "device_id_123",                 // ID устройства
    "msg_count": 5                         // Количество сообщений
  }
  ```

#### `/device-refresh-telemetry`
- **Описание:** Обновление телеметрии устройства за период.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, обязательный) — ID устройства.
  - `ts_from` (int, обязательный) — начало периода (timestamp).
  - `ts_to` (int, обязательный) — конец периода (timestamp).
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "device_id_123",                 // ID устройства
    "ts_from": 1717102800000,              // Начальный timestamp (01.06.2024 00:00:00)
    "ts_to": 1717189200000                 // Конечный timestamp (02.06.2024 00:00:00)
  }
  ```

#### `/device-source-types`
- **Описание:** Получение списка типов источников данных.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
- **Ответ:**
  - Список типов источников данных.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token"            // Токен сессии
  }
  ```
  
---

### 3. Телеметрия и данные датчиков

#### `/plot`
- **Описание:** Получение данных телеметрии для графиков.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `device` (string, обязательный) — ID устройства.
  - `keys` (array of strings, необязательный) — названия датчиков.
  - `ts_from` (integer, обязательный) — начало периода (timestamp).
  - `ts_to` (integer, обязательный) — конец периода (timestamp).
  - `days` (integer, необязательный) — количество дней (альтернатива `ts_from`/`ts_to`).
  - `interval` (integer, необязательный) — интервал группировки (в миллисекундах).
  - `dots_count` (integer, необязательный) — количество точек.
- **Ответ:**
  - Объект с данными телеметрии:
    - `data` (object) — данные по ключам.
    - `page_num` (long) — номер страницы.
    - `page_size` (long) — размер страницы.
    - `records_count` (long) — общее количество записей.
    - `status` (string) — статус выполнения ("OK").
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "device": "device_id_123",             // ID устройства
    "keys": ["airtemp", "soilmoist1"],     // Ключи датчиков из /device
    "ts_from": 1717102800000,              // Начальный timestamp (01.06.2024 00:00:00)
    "ts_to": 1717189200000,                // Конечный timestamp (02.06.2024 00:00:00)
    "interval": 3600000,                   // Группировка данных по 1 часу (мс)
    "dots_count": 200                      // Максимум 200 точек данных
  }
  ```
#### `/last_telemetry`
- **Описание:** Получение последних значений телеметрии.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `devices` (array of strings, обязательный) — список ID устройств.
  - `keys` (array of strings, необязательный) — названия датчиков.
  - **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "devices": ["device_id_123", "device_id_456"], // Список ID устройств
    "keys": ["airtemp", "battery"]         // Ключи датчиков из /device
  }
  ```
- **Ответ:**
  - Объект с последними значениями:
    - `data` (object) — данные по ключам.
    - `page_num` (long) — номер страницы.
    - `page_size` (long) — размер страницы.
    - `records_count` (long) — общее количество записей.
    - `status` (string) — статус выполнения ("OK").
  - **Пример ответа:**
    ```json
    {
      "data": {
        "airtemp": [
          {"ts": 1714521600000, "value": 24.0},
          {"ts": 1714525200000, "value": 25.0}
        ],
        "soiltemp": [
          {"ts": 1714521600000, "value": 19.0},
          {"ts": 1714525200000, "value": 19.0}
        ]
      }
    }
    ```

#### `/telemetry`
- **Описание:** Получение данных телеметрии за период.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `devices` (array of strings, обязательный) — список ID устройств.
  - `keys` (array of strings, необязательный) — названия датчиков.
  - `ts_from` (integer, необязательный) — начало периода.
  - `ts_to` (integer, необязательный) — конец периода.
  - `days` (integer, необязательный) — количество дней.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "devices": ["device_id_123"],          // Список ID устройств
    "keys": ["airtemp", "soilmoist1"],     // Ключи датчиков из /device
    "ts_from": 1717102800000,              // Начальный timestamp (01.06.2024 00:00:00)
    "ts_to": 1717189200000,                // Конечный timestamp (02.06.2024 00:00:00)
    "days": 7                              // Опционально: 7 дней как альтернатива
  }
  ```
- **Ответ:**
  - Объект с данными телеметрии:
    - `data` (object):
      - `entity_id` (string) — ID устройства.
      - `key` (string) — название датчика.
      - `ts` (integer) — время (timestamp).
      - `value` (number) — значение.
    - `page_num` (long) — номер страницы.
    - `page_size` (long) — размер страницы.
    - `records_count` (long) — общее количество записей.
    - `status` (string) — статус выполнения ("OK").
  - **Пример ответа:**
    ```json
    {
      "data": {
        "airtemp": [
          {"ts": 1714521600000, "value": 24.0},
          {"ts": 1714525200000, "value": 25.0}
        ],
        "soiltemp": [
          {"ts": 1714521600000, "value": 19.0},
          {"ts": 1714525200000, "value": 19.0}
        ]
      }
    }
    ```

#### `/get-gdd`
- **Описание:** Получение суммы активных температур (SAT).
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `device` (string, обязательный) — ID устройства.
  - `gdd_start_date` (integer, обязательный) — дата начала расчета (timestamp).
  - `gdd_base` (float, обязательный) — базовая температура.
  - `ts_from` (integer, обязательный) — начало периода.
  - `ts_to` (integer, обязательный) — конец периода.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "device": "device_id_123",             // ID устройства
    "keys": ["airtemp"],                   // Ключи датчиков из /device
    "gdd_start_date": 1717102800000,       // Дата начала расчета (01.06.2024 00:00:00)
    "gdd_base": 10.0,                      // Базовая температура
    "ts_from": 1717102800000,              // Начальный timestamp (01.06.2024 00:00:00)
    "ts_to": 1717189200000                 // Конечный timestamp (02.06.2024 00:00:00)
  }
  ```
- **Ответ:**
  - Объект с данными SAT:
    - `data` (object) — данные по ключам.
    - `page_num` (long) — номер страницы.
    - `page_size` (long) — размер страницы.
    - `records_count` (long) — общее количество записей.
    - `status` (string) — статус выполнения ("OK").

#### `/get-rodtemp`
- **Описание:** Получение данных датчиков термоштанги.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `device` (string, обязательный) — ID устройства.
  - `ts_from` (integer, необязательный) — начало периода.
  - `ts_to` (integer, необязательный) — конец периода.
  - `days` (integer, необязательный) — количество дней.
  - `interval` (integer, необязательный) — интервал группировки.
  - `dots_count` (integer, необязательный) — количество точек.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "device": "device_id_123",             // ID устройства
    "keys": ["rodtemp1", "rodtemp2"],      // Ключи датчиков из /device
    "ts_from": 1717102800000,              // Начальный timestamp (01.06.2024 00:00:00)
    "ts_to": 1717189200000,                // Конечный timestamp (02.06.2024 00:00:00)
    "interval": 3600000,                   // Группировка данных по 1 часу (мс)
    "dots_count": 200                      // Максимум 200 точек данных
  }
  ```
- **Ответ:**
  - Объект с данными термоштанги:
    - `data` (object) — температура на разных уровнях (`rodtemp1`, `rodtemp2`, и т.д.).
    - `page_num` (long) — номер страницы.
    - `page_size` (long) — размер страницы.
    - `records_count` (long) — общее количество записей.
    - `status` (string) — статус выполнения ("OK").

#### `/get-wind`
- **Описание:** Получение данных датчиков ветра.
- **Параметры:** Аналогичны `/get-rodtemp`.
- **Ответ:** Аналогичен `/get-rodtemp`.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "device": "device_id_123",             // ID устройства
    "keys": ["windspeed", "winddir"],      // Ключи датчиков из /device
    "ts_from": 1717102800000,              // Начальный timestamp (01.06.2024 00:00:00)
    "ts_to": 1717189200000,                // Конечный timestamp (02.06.2024 00:00:00)
    "interval": 3600000,                   // Группировка данных по 1 часу (мс)
    "dots_count": 200                      // Максимум 200 точек данных
  }
  ```
  
---

### 4. Дополнительные методы

#### `/check-formula`
- **Описание:** Проверка работы формулы датчика.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, обязательный) — ID устройства.
  - `formula` (string, обязательный) — формула для проверки.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "device_id_123",                 // ID устройства
    "formula": "airtemp > 30"              // Формула для проверки
  }
  ```
  
#### `/client`
- **Методы:** POST, PUT
- **Описание:** Получение (POST) или изменение (PUT) данных клиента.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, обязательный) — ID клиента.
  - `name` (string, необязательный) — имя клиента.
  - `address` (string, необязательный) — адрес.
  - `email` (string, необязательный) — email.
- **Пример запроса POST:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "client_id_123"                  // ID клиента
  }
  ```
- **Ответ:**
  - Данные клиента.
  
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "client_id_123",                 // ID клиента
    "name": "Новое имя клиента",
    "address": "Новый адрес",
    "email": "new_email@example.com"
  }
  ```

#### `/incident`
- **Описание:** Получение или изменение данных инцидента.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, необязательный) — ID инцидента.
  - `name` (string, необязательный) — имя инцидента.
  - `client_id` (string, необязательный) — ID клиента.
  - `created_ts` (integer, необязательный) — время создания (timestamp).
  - `comment` (string, необязательный) — комментарий.
  - `devices` (array, необязательный) — список устройств:
    - `id` (string) — ID устройства.
    - `name` (string) — имя устройства.
- **Пример запроса:**
```json
{
  "sid": "your_session_token",           // Токен сессии
  "id": "incident_id_123",               // ID инцидента
  "name": "Инцидент 1",
  "client_id": "client_id_123",
  "created_ts": 1717102800000,           // Время создания (01.06.2024 00:00:00)
  "comment": "Комментарий к инциденту",
  "devices": [
    {"id": "device_id_123", "name": "Устройство 1"}
  ]
}
```
- **Ответ:**
  - Объект инцидента:
    - `id` (string) — ID инцидента.
    - `name` (string) — имя инцидента.
    - `client` (object) — данные клиента.
    - `created_ts` (string) — время создания.
    - `devices` (array) — связанные устройства.

#### `/incidents`
- **Описание:** Получение списка инцидентов.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `filter` (object, необязательный) — настройки фильтрации.
  - `page_size` (long, необязательный) — размер страницы.
  - `page_num` (long, необязательный) — номер страницы.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "filter": {
      "name": "инцидент"
    },
    "page_size": 10,
    "page_num": 1
  }
  ```
- **Ответ:**
  - Массив инцидентов.

#### `/photo`
- **Описание:** Получение фотографии.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `photo_id` (string, обязательный) — ID фотографии.
  - `encode_base64` (boolean, необязательный) — кодировать в base64.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "photo_id": "photo_id_123",            // ID фотографии
    "encode_base64": true                  // Кодировать в base64
  }
  ```
- **Ответ:**
  - Изображение в формате PNG (или base64, если указано).

#### `/sensor`
- **Методы:** POST, PUT
- **Описание:** Получение, изменение или создание датчика.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `key` (string, обязательный) — ключ датчика.
  - `name` (string, необязательный) — имя датчика.
  - `description` (string, необязательный) — описание.
  - `type` (string, необязательный) — тип датчика.
  - `min_value` (number, необязательный) — минимальное значение.
  - `max_value` (number, необязательный) — максимальное значение.
  - `is_public` (boolean, необязательный) — публичный доступ.
  - `key_id` (integer, необязательный) — ID ключа.
  - `weight` (integer, необязательный) — вес.
  - `unit` (string, необязательный) — единица измерения.
  - `aggregation_function` (string, необязательный) — функция агрегации.
- **Пример запроса POST:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "key": "airtemp"                       // Ключ датчика
  }
  ```
- **Пример запроса PUT:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "key": "airtemp",                      // Ключ датчика
    "name": "Температура воздуха",
    "unit": "°C"
  }
  ```
#### `/sensor-template`
- **Методы:** POST, PUT, DELETE
- **Описание:** Управление шаблонами датчиков.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, необязательный) — ID шаблона.
  - `sensors` (object, необязательный) — данные датчиков.
  - `name` (string, необязательный) — имя шаблона.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "name": "Шаблон 1",
    "sensors": {
      "airtemp": {"name": "Температура воздуха", "unit": "°C"}
    }
  }
  ```
  
#### `/sensor-templates`
- **Описание:** Получение списка шаблонов датчиков.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `filter` (object, необязательный) — фильтр.
  - `page_num` (integer, необязательный) — номер страницы.
  - `page_size` (integer, необязательный) — размер страницы.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "filter": {
      "name": "шаблон"
    },
    "page_num": 1,
    "page_size": 10
  }
  ```
  
#### `/sensors`
- **Описание:** Получение списка датчиков.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token"            // Токен сессии
  }
  ```
  
#### `/tb-keys`
- **Описание:** Получение списка всех датчиков в Thingsboard.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token"            // Токен сессии
  }
  ```
  
#### `/update-data`
- **Описание:** Обновление телеметрии из внешнего источника.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `id` (string, обязательный) — ID устройства.
  - `date_from` (int, обязательный) — начало периода.
  - `date_to` (int, необязательный) — конец периода.
  - `force_update` (bool, необязательный) — принудительное обновление.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "id": "device_id_123",                 // ID устройства
    "date_from": 1717102800000,            // Начальный timestamp (01.06.2024 00:00:00)
    "date_to": 1717189200000,              // Конечный timestamp (02.06.2024 00:00:00)
    "force_update": true                   // Принудительное обновление
  }
  ```
  
#### `/user-settings`
- **Методы:** POST, PUT
- **Описание:** Получение или изменение пользовательских настроек.
- **Параметры:**
  - `sid` (string, обязательный) — токен сессии.
  - `device` (string, необязательный) — ID устройства.
  - `key` (string, обязательный) — ключ настройки.
  - `value` (string, необязательный) — значение настройки.
- **Ответ:**
  - Настройки пользователя.
- **Пример запроса:**
  ```json
  {
    "sid": "your_session_token",           // Токен сессии
    "key": "language",                     // Ключ настройки
    "value": "ru"                          // Значение настройки для метода PUT
  }
  ```
---

## Примечания

- Для методов `/telemetry` и `/plot` предоставлены примеры ответов в документации.
- Метод `/photo` возвращает изображение в формате PNG.
- API поддерживает пагинацию для методов, возвращающих списки (например, `/devices`, `/incidents`).

Данная спецификация охватывает все методы API сервиса **погодавполе.рф**, предоставляя полный инструментарий для работы с устройствами, телеметрией и настройками системы.